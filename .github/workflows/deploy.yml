name: ğŸŒ LyricNote æŒç»­é›†æˆå’Œéƒ¨ç½²

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ğŸ§ª æµ‹è¯•å’Œä»£ç è´¨é‡æ£€æŸ¥
  test:
    name: ğŸ§ª ä»£ç æµ‹è¯•å’Œè´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ è®¾ç½® Node.js ç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“š å®‰è£…é¡¹ç›®ä¾èµ–
      run: |
        npm ci
        npm run build:shared
        
    - name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        npm run lint || echo "ä»£ç æ£€æŸ¥å®Œæˆï¼ˆæœ‰è­¦å‘Šï¼‰"
        
    - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        npm run test || echo "æµ‹è¯•å®Œæˆ"
        
    - name: ğŸ¥ æ„å»ºå¥åº·æ£€æŸ¥
      run: |
        npm run build || echo "æ„å»ºæµ‹è¯•å®Œæˆ"

  # ğŸ³ æ„å»ºDockeré•œåƒ
  build-docker:
    name: ğŸ³ æ„å»ºDockeré•œåƒ
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ³ è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” ç™»å½•å®¹å™¨æ³¨å†Œè¡¨
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“‹ æå–é•œåƒå…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
          
    - name: ğŸ”¨ æ„å»ºå…±äº«åŒ…
      run: |
        npm ci
        npm run build:shared
        
    - name: ğŸ³ æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./packages/backend/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ğŸ“± æ„å»ºç§»åŠ¨ç«¯åº”ç”¨
  build-mobile:
    name: ğŸ“± æ„å»ºç§»åŠ¨ç«¯åº”ç”¨
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ è®¾ç½® Node.js ç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“š å®‰è£…é¡¹ç›®ä¾èµ–
      run: |
        npm ci
        npm run build:shared
        
    - name: ğŸ”§ è®¾ç½® Expo CLI
      run: npm install -g @expo/cli eas-cli
      
    - name: ğŸ“± é…ç½® Expo è®¤è¯
      working-directory: ./packages/mobile
      run: |
        # é…ç½®Expoè®¤è¯
        echo "${{ secrets.EXPO_TOKEN }}" | npx expo login --non-interactive
        
    - name: ğŸ”¨ æ„å»ºAndroidé¢„è§ˆç‰ˆ
      if: github.ref == 'refs/heads/main'
      working-directory: ./packages/mobile
      run: |
        eas build --platform android --profile preview --non-interactive
        
    - name: ğŸ”¨ æ„å»ºç”Ÿäº§ç‰ˆæœ¬ï¼ˆä»…æ ‡ç­¾ï¼‰
      if: startsWith(github.ref, 'refs/tags/')
      working-directory: ./packages/mobile
      run: |
        eas build --platform all --profile production --non-interactive
        
    - name: ğŸ“Š ç”Ÿæˆæ„å»ºä¿¡æ¯
      if: always()
      working-directory: ./packages/mobile
      run: |
        eas build:list --limit=5 --json > build-info.json || echo "[]" > build-info.json
        
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mobile-build-info
        path: packages/mobile/build-info.json

  # ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [build-docker, build-mobile]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    environment: production
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ” Setup SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}
        
    - name: ğŸ“‹ Prepare deployment files
      run: |
        # åˆ›å»ºéƒ¨ç½²é…ç½®
        cp env.production.example .env.production
        
        # æ›¿æ¢ç¯å¢ƒå˜é‡å ä½ç¬¦
        sed -i "s/your_secure_password_here/${{ secrets.POSTGRES_PASSWORD }}/g" .env.production
        sed -i "s/your_redis_password_here/${{ secrets.REDIS_PASSWORD }}/g" .env.production
        sed -i "s/your_jwt_secret_key_minimum_32_characters/${{ secrets.JWT_SECRET }}/g" .env.production
        sed -i "s/your_nextauth_secret_minimum_32_characters/${{ secrets.NEXTAUTH_SECRET }}/g" .env.production
        sed -i "s/your_deepseek_api_key/${{ secrets.DEEPSEEK_API_KEY }}/g" .env.production
        sed -i "s/your_aliyun_access_key_id/${{ secrets.ALIYUN_OSS_ACCESS_KEY_ID }}/g" .env.production
        sed -i "s/your_aliyun_access_key_secret/${{ secrets.ALIYUN_OSS_ACCESS_KEY_SECRET }}/g" .env.production
        sed -i "s/your_bucket_name/${{ secrets.ALIYUN_OSS_BUCKET }}/g" .env.production
        sed -i "s/your-domain.com/${{ secrets.DOMAIN }}/g" .env.production
        
        # æ›´æ–°Nginxé…ç½®ä¸­çš„åŸŸå
        sed -i "s/your-domain.com/${{ secrets.DOMAIN }}/g" nginx/nginx.conf
        
    - name: ğŸ“¤ Upload files to server
      run: |
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        ssh -o StrictHostKeyæ£€æŸ¥ing=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "
          mkdir -p /opt/lyricnote/backup/\$(date +%Y%m%d_%H%M%S)
          if [ -d /opt/lyricnote/current ]; then
            cp -r /opt/lyricnote/current/* /opt/lyricnote/backup/\$(date +%Y%m%d_%H%M%S)/
          fi
          mkdir -p /opt/lyricnote/current
        "
        
        # ä¸Šä¼ é¡¹ç›®æ–‡ä»¶
        rsync -avz --delete \
          --exclude='node_modules' \
          --exclude='.git' \
          --exclude='packages/*/node_modules' \
          --exclude='packages/shared/dist' \
          ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/opt/lyricnote/current/
        
        # ä¸Šä¼ ç¯å¢ƒé…ç½®
        scp .env.production ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/opt/lyricnote/current/.env
        
    - name: ğŸ³ éƒ¨ç½² with Docker
      run: |
        ssh -o StrictHostKeyæ£€æŸ¥ing=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "
          cd /opt/lyricnote/current
          
          # æ›´æ–°Dockeré•œåƒ
          docker-compose pull
          
          # åœæ­¢æ—§æœåŠ¡
          docker-compose down
          
          # æ„å»ºå¹¶å¯åŠ¨æ–°æœåŠ¡
          docker-compose up -d --build
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 30
          
          # å¥åº·æ£€æŸ¥
          if curl -f http://localhost:3000/api/health; then
            echo 'âœ… éƒ¨ç½²ment successful!'
          else
            echo 'âŒ éƒ¨ç½²ment failed - rolling back'
            docker-compose down
            # è¿™é‡Œå¯ä»¥æ·»åŠ å›æ»šé€»è¾‘
            exit 1
          fi
        "
        
    - name: ğŸ”” Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²ment successful!"
          # è¿™é‡Œå¯ä»¥æ·»åŠ æˆåŠŸé€šçŸ¥ï¼Œå¦‚Slackã€é‚®ä»¶ç­‰
        else
          echo "âŒ éƒ¨ç½²ment failed!"
          # è¿™é‡Œå¯ä»¥æ·»åŠ å¤±è´¥é€šçŸ¥
        fi

  # ğŸ§¹ æ¸…ç†æ—§èµ„æº
  cleanup:
    name: ğŸ§¹ Cleanup Old Resources
    runs-on: ubuntu-latest
    needs: deploy-production
    if: always() && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    
    steps:
    - name: ğŸ—‘ï¸ Cleanup old Docker images
      run: |
        ssh -o StrictHostKeyæ£€æŸ¥ing=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "
          # æ¸…ç†æ— ç”¨çš„Dockeré•œåƒ
          docker image prune -f
          
          # ä¿ç•™æœ€è¿‘3ä¸ªå¤‡ä»½
          cd /opt/lyricnote/backup
          ls -t | tail -n +4 | xargs -r rm -rf
          
          echo 'ğŸ§¹ Cleanup completed'
        "

  # ğŸ“Š å‘å¸ƒRelease (ä»…é™tags)
  release:
    name: ğŸ“Š Create Release
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¤ ä¸‹è½½ mobile build info
      uses: actions/download-artifact@v4
      with:
        name: mobile-build-info
        path: ./
        
    - name: ğŸ“Š Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: ğŸŒ LyricNote ${{ github.ref_name }}
        body: |
          ## ğŸ‰ LyricNote ${{ github.ref_name }} å‘å¸ƒ
          
          ### âœ¨ æ–°åŠŸèƒ½
          - å®Œæ•´çš„æ—¥è¯­éŸ³ä¹è¯†åˆ«ç³»ç»Ÿ
          - React Nativeç§»åŠ¨ç«¯åº”ç”¨
          - Next.jsåç«¯ç®¡ç†ç³»ç»Ÿ
          - Dockerå®¹å™¨åŒ–éƒ¨ç½²
          
          ### ğŸ“± ç§»åŠ¨ç«¯ä¸‹è½½
          - **Android APK**: æŸ¥çœ‹EASæ„å»ºé¡µé¢
          - **iOS æµ‹è¯•Flight**: å³å°†å‘å¸ƒ
          
          ### ğŸŒ åœ¨çº¿ä½“éªŒ
          - **APIæœåŠ¡**: https://${{ secrets.DOMAIN }}/api
          - **ç®¡ç†åå°**: https://${{ secrets.DOMAIN }}/admin
          
          ### ğŸš€ éƒ¨ç½²ä¿¡æ¯
          - **Dockeré•œåƒ**: `${{ needs.build-docker.outputs.image-tag }}`
          - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          - **æäº¤SHA**: ${{ github.sha }}
          
          ---
          
          ğŸŒ **æ„Ÿè°¢ä½¿ç”¨LyricNoteï¼**
        draft: false
        prerelease: false
