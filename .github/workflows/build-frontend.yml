name: Build Frontend Packages

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      platforms:
        description: 'è¦æ„å»ºçš„å¹³å° (desktop,mobile,miniapp,all)'
        required: false
        default: 'all'

env:
  PNPM_VERSION: 9

jobs:
  # ========== 1. å¾®ä¿¡å°ç¨‹åºæ„å»º ==========
  build-miniapp:
    name: æ„å»ºå¾®ä¿¡å°ç¨‹åº
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.platforms == 'miniapp' ||
      github.event.inputs.platforms == 'all' ||
      github.event.inputs.platforms == ''
    steps:
      - name: ğŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ æ„å»º Shared åŒ…
        run: |
          cd packages/shared
          pnpm build

      - name: ğŸ—ï¸ æ„å»ºå¾®ä¿¡å°ç¨‹åº
        run: |
          cd packages/miniapp
          pnpm build

      - name: ğŸ“¦ æ‰“åŒ…å°ç¨‹åºä»£ç 
        run: |
          cd packages/miniapp/dist
          zip -r ../miniapp-dist.zip .
          cd ..
          echo "âœ… å°ç¨‹åºä»£ç åŒ…å·²åˆ›å»º: miniapp-dist.zip"
          ls -lh miniapp-dist.zip

      - name: ğŸ“¤ ä¸Šä¼ å°ç¨‹åºä»£ç åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: miniapp-wechat-${{ github.sha }}
          path: packages/miniapp/miniapp-dist.zip
          retention-days: 30

      - name: ğŸ“Š æ„å»ºä¿¡æ¯
        run: |
          echo "ğŸ‰ å¾®ä¿¡å°ç¨‹åºæ„å»ºå®Œæˆï¼"
          echo "ğŸ“¦ äº§ç‰©åç§°: miniapp-wechat-${{ github.sha }}"
          echo "ğŸ’¾ æ–‡ä»¶å¤§å°: $(du -h packages/miniapp/miniapp-dist.zip | cut -f1)"

  # ========== 2. Desktop macOS æ„å»º ==========
  build-desktop-macos:
    name: æ„å»º Desktop (macOS)
    runs-on: macos-latest
    if: |
      github.event.inputs.platforms == 'desktop' ||
      github.event.inputs.platforms == 'all' ||
      github.event.inputs.platforms == ''
    steps:
      - name: ğŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ æ„å»º Shared åŒ…
        run: |
          cd packages/shared
          pnpm build

      - name: ğŸ—ï¸ æ„å»º Desktop (macOS)
        run: |
          cd packages/desktop
          pnpm build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¤ ä¸Šä¼  macOS å®‰è£…åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: desktop-macos-${{ github.sha }}
          path: |
            packages/desktop/release/*.dmg
            packages/desktop/release/*.zip
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ“Š æ„å»ºä¿¡æ¯
        run: |
          echo "ğŸ‰ macOS Desktop æ„å»ºå®Œæˆï¼"
          echo "ğŸ“¦ äº§ç‰©:"
          ls -lh packages/desktop/release/*.dmg 2>/dev/null || echo "æœªæ‰¾åˆ° .dmg æ–‡ä»¶"
          ls -lh packages/desktop/release/*.zip 2>/dev/null || echo "æœªæ‰¾åˆ° .zip æ–‡ä»¶"

  # ========== 3. Desktop Windows æ„å»º ==========
  build-desktop-windows:
    name: æ„å»º Desktop (Windows)
    runs-on: windows-latest
    if: |
      github.event.inputs.platforms == 'desktop' ||
      github.event.inputs.platforms == 'all' ||
      github.event.inputs.platforms == ''
    steps:
      - name: ğŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ æ„å»º Shared åŒ…
        run: |
          cd packages/shared
          pnpm build

      - name: ğŸ—ï¸ æ„å»º Desktop (Windows)
        run: |
          cd packages/desktop
          pnpm build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¤ ä¸Šä¼  Windows å®‰è£…åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: desktop-windows-${{ github.sha }}
          path: |
            packages/desktop/release/*.exe
            packages/desktop/release/*.msi
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ“Š æ„å»ºä¿¡æ¯
        run: |
          echo "ğŸ‰ Windows Desktop æ„å»ºå®Œæˆï¼"
          echo "ğŸ“¦ äº§ç‰©:"
          Get-ChildItem packages/desktop/release/*.exe -ErrorAction SilentlyContinue
          Get-ChildItem packages/desktop/release/*.msi -ErrorAction SilentlyContinue

  # ========== 4. Mobile iOS æ„å»º (EAS Build) ==========
  build-mobile-ios:
    name: æ„å»º Mobile (iOS)
    runs-on: ubuntu-latest
    if: |
      (github.event.inputs.platforms == 'mobile' ||
       github.event.inputs.platforms == 'all' ||
       github.event.inputs.platforms == '') &&
      github.event_name != 'pull_request'
    steps:
      - name: ğŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ æ„å»º Shared åŒ…
        run: |
          cd packages/shared
          pnpm build

      - name: ğŸ—ï¸ Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: â„¹ï¸ iOS æ„å»ºè¯´æ˜
        run: |
          echo "ğŸ“± iOS æ„å»ºéœ€è¦ Apple Developer è¯ä¹¦"
          echo ""
          echo "âš ï¸ iOS æ„å»ºåœ¨ CI ä¸­éœ€è¦é¢å¤–é…ç½®:"
          echo "1. Apple Developer è´¦å· ($99/å¹´)"
          echo "2. åœ¨ EAS ä¸­é…ç½® Distribution Certificate å’Œ Provisioning Profile"
          echo "3. è¿è¡Œ: cd packages/mobile && eas build --platform ios --profile production"
          echo ""
          echo "ğŸ”— é…ç½®æŒ‡å—: https://docs.expo.dev/app-signing/managed-credentials/"
          echo ""
          echo "ğŸ’¡ æ¨è: åœ¨æœ¬åœ°æ‰‹åŠ¨æ„å»º iOS,æˆ–ä½¿ç”¨ EAS Build çš„äº¤äº’æ¨¡å¼"

  # ========== 5. Mobile Android æ„å»º (EAS Build) ==========
  build-mobile-android:
    name: æ„å»º Mobile (Android)
    runs-on: ubuntu-latest
    if: |
      (github.event.inputs.platforms == 'mobile' ||
       github.event.inputs.platforms == 'all' ||
       github.event.inputs.platforms == '') &&
      github.event_name != 'pull_request'
    steps:
      - name: ğŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ æ„å»º Shared åŒ…
        run: |
          cd packages/shared
          pnpm build

      - name: ğŸ—ï¸ Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: â„¹ï¸ Android æ„å»ºè¯´æ˜
        run: |
          echo "ğŸ“± Android æ„å»ºéœ€è¦å…ˆåˆå§‹åŒ–è¯ä¹¦"
          echo ""
          echo "âš ï¸ é¦–æ¬¡æ„å»ºéœ€è¦äº¤äº’å¼è®¾ç½®:"
          echo "1. æœ¬åœ°è¿è¡Œ: cd packages/mobile && eas build --platform android"
          echo "2. é€‰æ‹©è®© EAS è‡ªåŠ¨ç”Ÿæˆ Keystore"
          echo "3. è¯ä¹¦ä¼šä¿å­˜åœ¨ Expo æœåŠ¡å™¨ä¸Š"
          echo ""
          echo "âœ… åˆå§‹åŒ–å,åç»­æ„å»ºå¯ä»¥åœ¨ CI ä¸­è‡ªåŠ¨è¿è¡Œ"
          echo ""
          echo "ğŸ”— é…ç½®æŒ‡å—: https://docs.expo.dev/app-signing/managed-credentials/"
          echo "ğŸ”— æŸ¥çœ‹æ„å»º: https://expo.dev"
          echo ""
          echo "ğŸ’¡ æˆ–ä½¿ç”¨ EAS Dashboard å¯è§†åŒ–ç•Œé¢æ„å»º"

  # ========== 6. æ„å»ºæ€»ç»“ ==========
  build-summary:
    name: ğŸ“Š æ„å»ºæ€»ç»“
    runs-on: ubuntu-latest
    needs:
      - build-miniapp
      - build-desktop-macos
      - build-desktop-windows
      - build-mobile-ios
      - build-mobile-android
    if: always()
    steps:
      - name: ğŸ“‹ ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        run: |
          echo "# ğŸ‰ LyricNote å‰ç«¯æ„å»ºå®Œæˆ"
          echo ""
          echo "## ğŸ“¦ æ„å»ºäº§ç‰©"
          echo ""
          echo "### 1ï¸âƒ£ å¾®ä¿¡å°ç¨‹åº"
          echo "- ğŸ“¦ äº§ç‰©: miniapp-wechat-${{ github.sha }}"
          echo "- ğŸ“ è¯´æ˜: å¯ä¸Šä¼ åˆ°å¾®ä¿¡å¼€å‘è€…å·¥å…·"
          echo ""
          echo "### 2ï¸âƒ£ Desktop æ¡Œé¢ç«¯"
          echo "- ğŸ macOS: desktop-macos-${{ github.sha }}"
          echo "- ğŸªŸ Windows: desktop-windows-${{ github.sha }}"
          echo ""
          echo "### 3ï¸âƒ£ Mobile ç§»åŠ¨ç«¯"
          echo "- ğŸ“± iOS: éœ€è¦æ‰‹åŠ¨æ„å»º (éœ€è¦ Apple Developer è¯ä¹¦)"
          echo "- ğŸ¤– Android: éœ€è¦å…ˆåˆå§‹åŒ–è¯ä¹¦åæ‰èƒ½è‡ªåŠ¨æ„å»º"
          echo "- ğŸ”— é¦–æ¬¡æ„å»º: cd packages/mobile && eas build"
          echo "- ğŸ”— æŸ¥çœ‹æ„å»º: https://expo.dev"
          echo ""
          echo "## ğŸ“¥ ä¸‹è½½æ–¹å¼"
          echo ""
          echo "1. åœ¨ GitHub Actions é¡µé¢æ‰¾åˆ°æœ¬æ¬¡è¿è¡Œ"
          echo "2. æ»šåŠ¨åˆ°åº•éƒ¨çš„ 'Artifacts' åŒºåŸŸ"
          echo "3. ç‚¹å‡»å¯¹åº”å¹³å°çš„äº§ç‰©åç§°ä¸‹è½½"
          echo ""
          echo "## ğŸ”§ ç‰ˆæœ¬ä¿¡æ¯"
          echo "- Commit: ${{ github.sha }}"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Run Number: ${{ github.run_number }}"
          echo "- Triggered by: ${{ github.actor }}"

      - name: ğŸ“Š çŠ¶æ€æ£€æŸ¥
        run: |
          echo "æ„å»ºçŠ¶æ€:"
          echo "- MiniApp: ${{ needs.build-miniapp.result }}"
          echo "- Desktop macOS: ${{ needs.build-desktop-macos.result }}"
          echo "- Desktop Windows: ${{ needs.build-desktop-windows.result }}"
          echo "- Mobile iOS: ${{ needs.build-mobile-ios.result }}"
          echo "- Mobile Android: ${{ needs.build-mobile-android.result }}"
