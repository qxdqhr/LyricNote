name: ğŸš§ Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ğŸš§ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-staging:
    name: ğŸš§ Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“š Install dependencies
      run: |
        npm ci
        npm run build:shared
        
    - name: ğŸ” Setup SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}
        
    - name: ğŸ“‹ Prepare staging environment
      run: |
        # åˆ›å»ºæµ‹è¯•ç¯å¢ƒé…ç½®
        cp env.production.example .env.staging
        
        # é…ç½®æµ‹è¯•ç¯å¢ƒå˜é‡
        sed -i "s/your_secure_password_here/${{ secrets.STAGING_POSTGRES_PASSWORD }}/g" .env.staging
        sed -i "s/your_redis_password_here/${{ secrets.STAGING_REDIS_PASSWORD }}/g" .env.staging
        sed -i "s/your_jwt_secret_key_minimum_32_characters/${{ secrets.STAGING_JWT_SECRET }}/g" .env.staging
        sed -i "s/your_nextauth_secret_minimum_32_characters/${{ secrets.STAGING_NEXTAUTH_SECRET }}/g" .env.staging
        sed -i "s/your_deepseek_api_key/${{ secrets.DEEPSEEK_API_KEY }}/g" .env.staging
        sed -i "s/your-domain.com/${{ secrets.STAGING_DOMAIN }}/g" .env.staging
        
        # æ›´æ–°Nginxé…ç½®
        sed -i "s/your-domain.com/${{ secrets.STAGING_DOMAIN }}/g" nginx/nginx.conf
        
    - name: ğŸš§ Deploy to staging server
      run: |
        # éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
        ssh -o StrictHostKeyChecking=no ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} "
          mkdir -p /opt/lyricnote-staging
          cd /opt/lyricnote-staging
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          if [ -d current ]; then
            mv current backup-\$(date +%Y%m%d_%H%M%S)
          fi
          mkdir -p current
        "
        
        # ä¸Šä¼ ä»£ç 
        rsync -avz --delete \
          --exclude='node_modules' \
          --exclude='.git' \
          --exclude='packages/*/node_modules' \
          ./ ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }}:/opt/lyricnote-staging/current/
        
        # ä¸Šä¼ ç¯å¢ƒé…ç½®
        scp .env.staging ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }}:/opt/lyricnote-staging/current/.env
        
    - name: ğŸš€ Start staging services
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} "
          cd /opt/lyricnote-staging/current
          
          # åœæ­¢æ—§æœåŠ¡
          docker-compose -f docker-compose.yml -f docker-compose.staging.yml down || true
          
          # æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
          docker-compose -f docker-compose.yml -f docker-compose.staging.yml up -d --build
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 30
          
          # å¥åº·æ£€æŸ¥
          if curl -f http://localhost:3000/api/health; then
            echo 'âœ… Staging deployment successful!'
          else
            echo 'âŒ Staging deployment failed'
            docker-compose -f docker-compose.yml -f docker-compose.staging.yml logs
            exit 1
          fi
        "
        
    - name: ğŸ§ª Run smoke tests
      run: |
        # è¿è¡ŒåŸºç¡€çš„å†’çƒŸæµ‹è¯•
        sleep 10
        
        # æµ‹è¯•APIå¥åº·çŠ¶æ€
        if curl -f "https://${{ secrets.STAGING_DOMAIN }}/api/health"; then
          echo "âœ… API health check passed"
        else
          echo "âŒ API health check failed"
          exit 1
        fi
        
        # æµ‹è¯•ç®¡ç†é¡µé¢
        if curl -f "https://${{ secrets.STAGING_DOMAIN }}/admin"; then
          echo "âœ… Admin page accessible"
        else
          echo "âŒ Admin page not accessible"
          exit 1
        fi
        
    - name: ğŸ“Š Generate staging report
      if: always()
      run: |
        echo "# ğŸš§ Staging Deployment Report" > staging-report.md
        echo "" >> staging-report.md
        echo "**Environment**: Staging" >> staging-report.md
        echo "**Date**: $(date)" >> staging-report.md
        echo "**Commit**: ${{ github.sha }}" >> staging-report.md
        echo "**Branch**: ${{ github.ref_name }}" >> staging-report.md
        echo "" >> staging-report.md
        
        echo "## ğŸ”— Access Links" >> staging-report.md
        echo "- **Frontend**: https://${{ secrets.STAGING_DOMAIN }}" >> staging-report.md
        echo "- **API**: https://${{ secrets.STAGING_DOMAIN }}/api" >> staging-report.md
        echo "- **Admin**: https://${{ secrets.STAGING_DOMAIN }}/admin" >> staging-report.md
        echo "- **Health Check**: https://${{ secrets.STAGING_DOMAIN }}/api/health" >> staging-report.md
        echo "" >> staging-report.md
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "## âœ… Deployment Status: SUCCESS" >> staging-report.md
          echo "Staging environment is ready for testing!" >> staging-report.md
        else
          echo "## âŒ Deployment Status: FAILED" >> staging-report.md
          echo "Please check the logs for more details." >> staging-report.md
        fi
        
    - name: ğŸ“¤ Upload staging report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: staging-report
        path: staging-report.md
        
    - name: ğŸ”” Notify team
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ Staging deployment successful!"
          echo "ğŸ”— Access at: https://${{ secrets.STAGING_DOMAIN }}"
        else
          echo "âŒ Staging deployment failed!"
        fi
