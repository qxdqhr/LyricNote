name: 📱 移动端应用构建

on:
  push:
    branches: [ main, develop ]
    paths: 
      - 'packages/mobile/**'
      - 'packages/shared/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'packages/mobile/**'
      - 'packages/shared/**'
      workflow_dispatch:
    inputs:
      platform:
        description: '构建平台'
        required: true
        default: 'android'
        type: choice
        options:
          - android
          - ios
          - all
      profile:
        description: '构建配置'
        required: true
        default: 'preview'
        type: choice
        options:
          - development
          - preview
          - production

env:
  NODE_VERSION: '18'

jobs:
  # 📱 移动端构建
  mobile-build:
    name: 📱 构建移动端应用
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        platform: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.platform)) || fromJSON('["android"]') }}
        profile: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.profile)) || fromJSON('["preview"]') }}
    
    steps:
    - name: 📥 检出代码
      uses: actions/checkout@v4
      
    - name: 📦 设置 Node.js 环境
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: 📚 安装项目依赖
      run: |
        npm ci
        npm run build:shared
        
    - name: 🔧 设置 Expo CLI
      run: |
        npm install -g @expo/cli eas-cli
        
    - name: 📱 Expo Authentication
      working-directory: ./packages/mobile
      run: |
        echo "${{ secrets.EXPO_TOKEN }}" | npx expo login --non-interactive
        
    - name: 🔍 Validate Expo configuration
      working-directory: ./packages/mobile
      run: |
        npx expo config --type=public
        npx expo doctor
        
    - name: 🔨 构建Android
      if: matrix.platform == 'android' || matrix.platform == 'all'
      working-directory: ./packages/mobile
      run: |
        echo "🤖 Building Android app with profile: ${{ matrix.profile }}"
        eas build --platform android --profile ${{ matrix.profile }} --non-interactive --wait
        
    - name: 🔨 构建iOS
      if: matrix.platform == 'ios' || matrix.platform == 'all'
      working-directory: ./packages/mobile
      run: |
        echo "🍎 Building iOS app with profile: ${{ matrix.profile }}"
        eas build --platform ios --profile ${{ matrix.profile }} --non-interactive --wait
        
    - name: 📊 Get build information
      if: always()
      working-directory: ./packages/mobile
      run: |
        eas build:list --limit=5 --json > build-info.json
        cat build-info.json
        
    - name: 📤 上传构建 artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mobile-build-${{ matrix.platform }}-${{ matrix.profile }}
        path: |
          packages/mobile/build-info.json
          packages/mobile/eas.json
          
    - name: 💬 Comment build info on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const buildInfo = JSON.parse(fs.readFileSync('packages/mobile/build-info.json', 'utf8'));
            const latestBuild = buildInfo[0];
            
            if (latestBuild) {
              const comment = `## 📱 Mobile Build Completed
              
              **Platform**: ${{ matrix.platform }}
              **Profile**: ${{ matrix.profile }}
              **Status**: ${latestBuild.status}
              **Build ID**: ${latestBuild.id}
              
              ${latestBuild.artifacts ? `**下载**: [${latestBuild.artifacts.buildUrl}](${latestBuild.artifacts.buildUrl})` : ''}
              
              **Build Time**: ${new Date(latestBuild.createdAt).toLocaleString()}
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
          } catch (error) {
            console.log('Error reading build info:', error);
          }

  # 🚀 自动提交到应用商店 (仅生产构建)
  submit-stores:
    name: 🚀 Submit to App Stores
    runs-on: ubuntu-latest
    needs: mobile-build
    if: github.ref == 'refs/heads/main' && github.event.inputs.profile == 'production'
    
    steps:
    - name: 📥 检出代码
      uses: actions/checkout@v4
      
    - name: 📦 设置 Node.js 环境
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: 🔧 设置 Expo CLI
      run: npm install -g @expo/cli eas-cli
      
    - name: 📱 Expo Authentication
      working-directory: ./packages/mobile
      run: |
        echo "${{ secrets.EXPO_TOKEN }}" | npx expo login --non-interactive
        
    - name: 🍎 Submit to App Store
      if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all'
      working-directory: ./packages/mobile
      run: |
        eas submit --platform ios --latest --non-interactive
        
    - name: 🤖 Submit to Google Play
      if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'all'
      working-directory: ./packages/mobile
      run: |
        eas submit --platform android --latest --non-interactive

  # 📊 构建报告
  build-report:
    name: 📊 Build Report
    runs-on: ubuntu-latest
    needs: mobile-build
    if: always()
    
    steps:
    - name: 📤 下载 build artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./build-artifacts
        
    - name: 📊 生成 build report
      run: |
        echo "# 📱 Mobile Build Report" > build-report.md
        echo "" >> build-report.md
        echo "**Build Date**: $(date)" >> build-report.md
        echo "**Commit**: ${{ github.sha }}" >> build-report.md
        echo "**Branch**: ${{ github.ref_name }}" >> build-report.md
        echo "" >> build-report.md
        
        echo "## 📋 Build Artifacts" >> build-report.md
        find ./build-artifacts -name "*.json" -exec echo "- {}" \; >> build-report.md
        
        echo "" >> build-report.md
        echo "## 🔗 Useful Links" >> build-report.md
        echo "- [EAS Build Dashboard](https://expo.dev/accounts/${{ secrets.EXPO_USERNAME }}/projects/lyricnote/builds)" >> build-report.md
        echo "- [GitHub Repository](https://github.com/${{ github.repository }})" >> build-report.md
        
    - name: 📤 上传构建 report
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: build-report.md
