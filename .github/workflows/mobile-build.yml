name: ğŸ“± Mobile App Build

on:
  push:
    branches: [ main, develop ]
    paths: 
      - 'packages/mobile/**'
      - 'packages/shared/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'packages/mobile/**'
      - 'packages/shared/**'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Build platform'
        required: true
        default: 'android'
        type: choice
        options:
          - android
          - ios
          - all
      profile:
        description: 'Build profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - development
          - preview
          - production

env:
  NODE_VERSION: '18'

jobs:
  # ğŸ“± ç§»åŠ¨ç«¯æ„å»º
  mobile-build:
    name: ğŸ“± Build Mobile App
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        platform: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.platform)) || fromJSON('["android"]') }}
        profile: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.profile)) || fromJSON('["preview"]') }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“š Install dependencies
      run: |
        npm ci
        npm run build:shared
        
    - name: ğŸ”§ Setup Expo CLI
      run: |
        npm install -g @expo/cli eas-cli
        
    - name: ğŸ“± Expo Authentication
      working-directory: ./packages/mobile
      run: |
        echo "${{ secrets.EXPO_TOKEN }}" | npx expo login --non-interactive
        
    - name: ğŸ” Validate Expo configuration
      working-directory: ./packages/mobile
      run: |
        npx expo config --type=public
        npx expo doctor
        
    - name: ğŸ”¨ Build Android
      if: matrix.platform == 'android' || matrix.platform == 'all'
      working-directory: ./packages/mobile
      run: |
        echo "ğŸ¤– Building Android app with profile: ${{ matrix.profile }}"
        eas build --platform android --profile ${{ matrix.profile }} --non-interactive --wait
        
    - name: ğŸ”¨ Build iOS
      if: matrix.platform == 'ios' || matrix.platform == 'all'
      working-directory: ./packages/mobile
      run: |
        echo "ğŸ Building iOS app with profile: ${{ matrix.profile }}"
        eas build --platform ios --profile ${{ matrix.profile }} --non-interactive --wait
        
    - name: ğŸ“Š Get build information
      if: always()
      working-directory: ./packages/mobile
      run: |
        eas build:list --limit=5 --json > build-info.json
        cat build-info.json
        
    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mobile-build-${{ matrix.platform }}-${{ matrix.profile }}
        path: |
          packages/mobile/build-info.json
          packages/mobile/eas.json
          
    - name: ğŸ’¬ Comment build info on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const buildInfo = JSON.parse(fs.readFileSync('packages/mobile/build-info.json', 'utf8'));
            const latestBuild = buildInfo[0];
            
            if (latestBuild) {
              const comment = `## ğŸ“± Mobile Build Completed
              
              **Platform**: ${{ matrix.platform }}
              **Profile**: ${{ matrix.profile }}
              **Status**: ${latestBuild.status}
              **Build ID**: ${latestBuild.id}
              
              ${latestBuild.artifacts ? `**Download**: [${latestBuild.artifacts.buildUrl}](${latestBuild.artifacts.buildUrl})` : ''}
              
              **Build Time**: ${new Date(latestBuild.createdAt).toLocaleString()}
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
          } catch (error) {
            console.log('Error reading build info:', error);
          }

  # ğŸš€ è‡ªåŠ¨æäº¤åˆ°åº”ç”¨å•†åº— (ä»…ç”Ÿäº§æ„å»º)
  submit-stores:
    name: ğŸš€ Submit to App Stores
    runs-on: ubuntu-latest
    needs: mobile-build
    if: github.ref == 'refs/heads/main' && github.event.inputs.profile == 'production'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ”§ Setup Expo CLI
      run: npm install -g @expo/cli eas-cli
      
    - name: ğŸ“± Expo Authentication
      working-directory: ./packages/mobile
      run: |
        echo "${{ secrets.EXPO_TOKEN }}" | npx expo login --non-interactive
        
    - name: ğŸ Submit to App Store
      if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all'
      working-directory: ./packages/mobile
      run: |
        eas submit --platform ios --latest --non-interactive
        
    - name: ğŸ¤– Submit to Google Play
      if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'all'
      working-directory: ./packages/mobile
      run: |
        eas submit --platform android --latest --non-interactive

  # ğŸ“Š æ„å»ºæŠ¥å‘Š
  build-report:
    name: ğŸ“Š Build Report
    runs-on: ubuntu-latest
    needs: mobile-build
    if: always()
    
    steps:
    - name: ğŸ“¤ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./build-artifacts
        
    - name: ğŸ“Š Generate build report
      run: |
        echo "# ğŸ“± Mobile Build Report" > build-report.md
        echo "" >> build-report.md
        echo "**Build Date**: $(date)" >> build-report.md
        echo "**Commit**: ${{ github.sha }}" >> build-report.md
        echo "**Branch**: ${{ github.ref_name }}" >> build-report.md
        echo "" >> build-report.md
        
        echo "## ğŸ“‹ Build Artifacts" >> build-report.md
        find ./build-artifacts -name "*.json" -exec echo "- {}" \; >> build-report.md
        
        echo "" >> build-report.md
        echo "## ğŸ”— Useful Links" >> build-report.md
        echo "- [EAS Build Dashboard](https://expo.dev/accounts/${{ secrets.EXPO_USERNAME }}/projects/lyricnote/builds)" >> build-report.md
        echo "- [GitHub Repository](https://github.com/${{ github.repository }})" >> build-report.md
        
    - name: ğŸ“¤ Upload build report
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: build-report.md
