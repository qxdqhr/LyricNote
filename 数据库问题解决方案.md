# 🔧 数据库连接问题解决方案

## 🔍 问题诊断

### 当前状态
- ✅ PostgreSQL已安装：`/opt/homebrew/bin/psql`
- ❌ PostgreSQL服务未运行
- ✅ 配置文件存在：`.env.local`
- ⚠️ Homebrew版本问题（macOS 26.0.1 beta不支持）

### 错误信息
```
code: 'ECONNREFUSED'
Failed query: select ... from "User"
```

### 数据库配置
```env
DATABASE_URL="postgresql://lyricnote_dev:dev_password_123@localhost:5433/lyricnote_dev"
```

---

## ✅ 解决方案

### 方案1：启动PostgreSQL（推荐）

#### 步骤1：查找PostgreSQL数据目录
```bash
ls -la /opt/homebrew/var/postgresql*
# 或
ls -la ~/Library/Application\ Support/Postgres/
```

#### 步骤2：手动启动PostgreSQL
```bash
# 方式A：使用pg_ctl（如果知道数据目录）
pg_ctl -D /opt/homebrew/var/postgresql@15 start

# 方式B：使用postgres命令
postgres -D /opt/homebrew/var/postgresql@15

# 方式C：尝试通过brew启动（可能因版本问题失败）
brew services start postgresql@15
```

#### 步骤3：验证PostgreSQL是否运行
```bash
ps aux | grep postgres | grep -v grep
# 或
psql -U postgres -c "SELECT version();"
```

---

### 方案2：使用Docker PostgreSQL（最简单）⭐

推荐使用Docker，避免本地PostgreSQL配置问题：

#### 步骤1：启动PostgreSQL容器
```bash
docker run -d \
  --name lyricnote-postgres \
  -e POSTGRES_USER=lyricnote_dev \
  -e POSTGRES_PASSWORD=dev_password_123 \
  -e POSTGRES_DB=lyricnote_dev \
  -p 5433:5432 \
  postgres:15-alpine
```

#### 步骤2：验证容器运行
```bash
docker ps | grep lyricnote-postgres
```

#### 步骤3：测试连接
```bash
docker exec -it lyricnote-postgres psql -U lyricnote_dev -d lyricnote_dev
# 输入：\l 查看数据库
# 输入：\q 退出
```

---

### 方案3：修改端口配置

如果5433端口被占用，可以修改为默认的5432：

#### 步骤1：修改.env.local
```bash
cd /Users/qihongrui/Desktop/LyricNote/packages/backend
```

修改为：
```env
DATABASE_URL="postgresql://lyricnote_dev:dev_password_123@localhost:5432/lyricnote_dev"
```

#### 步骤2：启动PostgreSQL在默认端口
```bash
# Docker方式（推荐）
docker run -d \
  --name lyricnote-postgres \
  -e POSTGRES_USER=lyricnote_dev \
  -e POSTGRES_PASSWORD=dev_password_123 \
  -e POSTGRES_DB=lyricnote_dev \
  -p 5432:5432 \
  postgres:15-alpine
```

---

## 🚀 启动后需要做的

### 1. 创建数据库和用户（如果使用本地PostgreSQL）

```bash
# 连接到PostgreSQL
psql -U postgres

# 创建用户
CREATE USER lyricnote_dev WITH PASSWORD 'dev_password_123';

# 创建数据库
CREATE DATABASE lyricnote_dev OWNER lyricnote_dev;

# 授予权限
GRANT ALL PRIVILEGES ON DATABASE lyricnote_dev TO lyricnote_dev;

# 退出
\q
```

### 2. 运行数据库迁移

```bash
cd /Users/qihongrui/Desktop/LyricNote/packages/backend

# 生成迁移（如果需要）
pnpm db:dev:generate

# 推送到数据库
pnpm db:dev:push
```

### 3. 重启Backend应用

```bash
cd /Users/qihongrui/Desktop/LyricNote/packages/backend
pnpm dev
```

---

## 🎯 快速命令集合

### 使用Docker（推荐）⭐

```bash
# 1. 启动PostgreSQL
docker run -d \
  --name lyricnote-postgres \
  -e POSTGRES_USER=lyricnote_dev \
  -e POSTGRES_PASSWORD=dev_password_123 \
  -e POSTGRES_DB=lyricnote_dev \
  -p 5433:5432 \
  postgres:15-alpine

# 2. 运行迁移
cd /Users/qihongrui/Desktop/LyricNote/packages/backend
pnpm db:dev:push

# 3. 启动应用
pnpm dev
```

### 停止和清理
```bash
# 停止容器
docker stop lyricnote-postgres

# 删除容器
docker rm lyricnote-postgres

# 重新开始（会丢失数据）
docker rm -f lyricnote-postgres
# 然后重新运行上面的docker run命令
```

### 保持数据持久化
```bash
# 创建数据卷
docker volume create lyricnote-pgdata

# 启动时挂载卷
docker run -d \
  --name lyricnote-postgres \
  -e POSTGRES_USER=lyricnote_dev \
  -e POSTGRES_PASSWORD=dev_password_123 \
  -e POSTGRES_DB=lyricnote_dev \
  -p 5433:5432 \
  -v lyricnote-pgdata:/var/lib/postgresql/data \
  postgres:15-alpine
```

---

## 🔍 故障排查

### 问题1：端口已被占用
```bash
# 查看5433端口占用
lsof -i :5433

# 如果有进程占用，可以：
# 1. 杀掉进程：kill -9 <PID>
# 2. 或使用其他端口（修改.env.local）
```

### 问题2：Docker未安装
```bash
# 安装Docker Desktop
# 下载：https://www.docker.com/products/docker-desktop

# 或使用Homebrew（可能因macOS版本问题失败）
brew install --cask docker
```

### 问题3：权限问题
```bash
# 如果psql命令提示权限问题
sudo -u postgres psql

# 或修改pg_hba.conf配置
```

### 问题4：数据库迁移失败
```bash
# 查看迁移文件
ls -la /Users/qihongrui/Desktop/LyricNote/packages/backend/drizzle/migrations/

# 手动运行SQL
psql -U lyricnote_dev -d lyricnote_dev -f /Users/qihongrui/Desktop/LyricNote/packages/backend/drizzle/migrations/0000_lovely_lilandra.sql
```

---

## 📝 验证清单

完成后验证：

- [ ] PostgreSQL正在运行
  ```bash
  ps aux | grep postgres | grep -v grep
  # 或
  docker ps | grep lyricnote-postgres
  ```

- [ ] 可以连接数据库
  ```bash
  psql -U lyricnote_dev -d lyricnote_dev -h localhost -p 5433
  ```

- [ ] 数据库表已创建
  ```bash
  psql -U lyricnote_dev -d lyricnote_dev -h localhost -p 5433 -c "\dt"
  ```

- [ ] Backend应用可以启动
  ```bash
  cd /Users/qihongrui/Desktop/LyricNote/packages/backend
  pnpm dev
  ```

- [ ] 可以访问管理后台
  ```
  http://localhost:3000/admin/login
  ```

---

## 💡 最佳实践

### 开发环境推荐
1. **使用Docker PostgreSQL**
   - 隔离环境
   - 易于清理和重置
   - 版本控制方便

2. **使用docker-compose**（可选）
   ```yaml
   # docker-compose.yml
   version: '3.8'
   services:
     postgres:
       image: postgres:15-alpine
       environment:
         POSTGRES_USER: lyricnote_dev
         POSTGRES_PASSWORD: dev_password_123
         POSTGRES_DB: lyricnote_dev
       ports:
         - "5433:5432"
       volumes:
         - pgdata:/var/lib/postgresql/data
   
   volumes:
     pgdata:
   ```
   
   启动：
   ```bash
   docker-compose up -d
   ```

### 生产环境
- 使用云数据库（如Aliyun RDS、AWS RDS）
- 配置在 `.env.production`

---

## 🆘 还是无法解决？

如果以上方案都不行，请提供以下信息：

1. PostgreSQL版本
   ```bash
   psql --version
   ```

2. 系统信息
   ```bash
   uname -a
   sw_vers
   ```

3. 端口占用情况
   ```bash
   lsof -i :5432
   lsof -i :5433
   ```

4. 完整错误日志
   ```bash
   cd packages/backend
   pnpm dev 2>&1 | tee backend-error.log
   ```

我会根据这些信息提供更具体的解决方案。

