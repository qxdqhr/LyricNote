# ğŸ”§ æ•°æ®åº“è¿æ¥é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ” é—®é¢˜è¯Šæ–­

### å½“å‰çŠ¶æ€
- âœ… PostgreSQLå·²å®‰è£…ï¼š`/opt/homebrew/bin/psql`
- âŒ PostgreSQLæœåŠ¡æœªè¿è¡Œ
- âœ… é…ç½®æ–‡ä»¶å­˜åœ¨ï¼š`.env.local`
- âš ï¸ Homebrewç‰ˆæœ¬é—®é¢˜ï¼ˆmacOS 26.0.1 betaä¸æ”¯æŒï¼‰

### é”™è¯¯ä¿¡æ¯
```
code: 'ECONNREFUSED'
Failed query: select ... from "User"
```

### æ•°æ®åº“é…ç½®
```env
DATABASE_URL="postgresql://lyricnote_dev:dev_password_123@localhost:5433/lyricnote_dev"
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå¯åŠ¨PostgreSQLï¼ˆæ¨èï¼‰

#### æ­¥éª¤1ï¼šæŸ¥æ‰¾PostgreSQLæ•°æ®ç›®å½•
```bash
ls -la /opt/homebrew/var/postgresql*
# æˆ–
ls -la ~/Library/Application\ Support/Postgres/
```

#### æ­¥éª¤2ï¼šæ‰‹åŠ¨å¯åŠ¨PostgreSQL
```bash
# æ–¹å¼Aï¼šä½¿ç”¨pg_ctlï¼ˆå¦‚æœçŸ¥é“æ•°æ®ç›®å½•ï¼‰
pg_ctl -D /opt/homebrew/var/postgresql@15 start

# æ–¹å¼Bï¼šä½¿ç”¨postgreså‘½ä»¤
postgres -D /opt/homebrew/var/postgresql@15

# æ–¹å¼Cï¼šå°è¯•é€šè¿‡brewå¯åŠ¨ï¼ˆå¯èƒ½å› ç‰ˆæœ¬é—®é¢˜å¤±è´¥ï¼‰
brew services start postgresql@15
```

#### æ­¥éª¤3ï¼šéªŒè¯PostgreSQLæ˜¯å¦è¿è¡Œ
```bash
ps aux | grep postgres | grep -v grep
# æˆ–
psql -U postgres -c "SELECT version();"
```

---

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨Docker PostgreSQLï¼ˆæœ€ç®€å•ï¼‰â­

æ¨èä½¿ç”¨Dockerï¼Œé¿å…æœ¬åœ°PostgreSQLé…ç½®é—®é¢˜ï¼š

#### æ­¥éª¤1ï¼šå¯åŠ¨PostgreSQLå®¹å™¨
```bash
docker run -d \
  --name lyricnote-postgres \
  -e POSTGRES_USER=lyricnote_dev \
  -e POSTGRES_PASSWORD=dev_password_123 \
  -e POSTGRES_DB=lyricnote_dev \
  -p 5433:5432 \
  postgres:15-alpine
```

#### æ­¥éª¤2ï¼šéªŒè¯å®¹å™¨è¿è¡Œ
```bash
docker ps | grep lyricnote-postgres
```

#### æ­¥éª¤3ï¼šæµ‹è¯•è¿æ¥
```bash
docker exec -it lyricnote-postgres psql -U lyricnote_dev -d lyricnote_dev
# è¾“å…¥ï¼š\l æŸ¥çœ‹æ•°æ®åº“
# è¾“å…¥ï¼š\q é€€å‡º
```

---

### æ–¹æ¡ˆ3ï¼šä¿®æ”¹ç«¯å£é…ç½®

å¦‚æœ5433ç«¯å£è¢«å ç”¨ï¼Œå¯ä»¥ä¿®æ”¹ä¸ºé»˜è®¤çš„5432ï¼š

#### æ­¥éª¤1ï¼šä¿®æ”¹.env.local
```bash
cd /Users/qihongrui/Desktop/LyricNote/packages/backend
```

ä¿®æ”¹ä¸ºï¼š
```env
DATABASE_URL="postgresql://lyricnote_dev:dev_password_123@localhost:5432/lyricnote_dev"
```

#### æ­¥éª¤2ï¼šå¯åŠ¨PostgreSQLåœ¨é»˜è®¤ç«¯å£
```bash
# Dockeræ–¹å¼ï¼ˆæ¨èï¼‰
docker run -d \
  --name lyricnote-postgres \
  -e POSTGRES_USER=lyricnote_dev \
  -e POSTGRES_PASSWORD=dev_password_123 \
  -e POSTGRES_DB=lyricnote_dev \
  -p 5432:5432 \
  postgres:15-alpine
```

---

## ğŸš€ å¯åŠ¨åéœ€è¦åšçš„

### 1. åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·ï¼ˆå¦‚æœä½¿ç”¨æœ¬åœ°PostgreSQLï¼‰

```bash
# è¿æ¥åˆ°PostgreSQL
psql -U postgres

# åˆ›å»ºç”¨æˆ·
CREATE USER lyricnote_dev WITH PASSWORD 'dev_password_123';

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE lyricnote_dev OWNER lyricnote_dev;

# æˆäºˆæƒé™
GRANT ALL PRIVILEGES ON DATABASE lyricnote_dev TO lyricnote_dev;

# é€€å‡º
\q
```

### 2. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
cd /Users/qihongrui/Desktop/LyricNote/packages/backend

# ç”Ÿæˆè¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰
pnpm db:dev:generate

# æ¨é€åˆ°æ•°æ®åº“
pnpm db:dev:push
```

### 3. é‡å¯Backendåº”ç”¨

```bash
cd /Users/qihongrui/Desktop/LyricNote/packages/backend
pnpm dev
```

---

## ğŸ¯ å¿«é€Ÿå‘½ä»¤é›†åˆ

### ä½¿ç”¨Dockerï¼ˆæ¨èï¼‰â­

```bash
# 1. å¯åŠ¨PostgreSQL
docker run -d \
  --name lyricnote-postgres \
  -e POSTGRES_USER=lyricnote_dev \
  -e POSTGRES_PASSWORD=dev_password_123 \
  -e POSTGRES_DB=lyricnote_dev \
  -p 5433:5432 \
  postgres:15-alpine

# 2. è¿è¡Œè¿ç§»
cd /Users/qihongrui/Desktop/LyricNote/packages/backend
pnpm db:dev:push

# 3. å¯åŠ¨åº”ç”¨
pnpm dev
```

### åœæ­¢å’Œæ¸…ç†
```bash
# åœæ­¢å®¹å™¨
docker stop lyricnote-postgres

# åˆ é™¤å®¹å™¨
docker rm lyricnote-postgres

# é‡æ–°å¼€å§‹ï¼ˆä¼šä¸¢å¤±æ•°æ®ï¼‰
docker rm -f lyricnote-postgres
# ç„¶åé‡æ–°è¿è¡Œä¸Šé¢çš„docker runå‘½ä»¤
```

### ä¿æŒæ•°æ®æŒä¹…åŒ–
```bash
# åˆ›å»ºæ•°æ®å·
docker volume create lyricnote-pgdata

# å¯åŠ¨æ—¶æŒ‚è½½å·
docker run -d \
  --name lyricnote-postgres \
  -e POSTGRES_USER=lyricnote_dev \
  -e POSTGRES_PASSWORD=dev_password_123 \
  -e POSTGRES_DB=lyricnote_dev \
  -p 5433:5432 \
  -v lyricnote-pgdata:/var/lib/postgresql/data \
  postgres:15-alpine
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šç«¯å£å·²è¢«å ç”¨
```bash
# æŸ¥çœ‹5433ç«¯å£å ç”¨
lsof -i :5433

# å¦‚æœæœ‰è¿›ç¨‹å ç”¨ï¼Œå¯ä»¥ï¼š
# 1. æ€æ‰è¿›ç¨‹ï¼škill -9 <PID>
# 2. æˆ–ä½¿ç”¨å…¶ä»–ç«¯å£ï¼ˆä¿®æ”¹.env.localï¼‰
```

### é—®é¢˜2ï¼šDockeræœªå®‰è£…
```bash
# å®‰è£…Docker Desktop
# ä¸‹è½½ï¼šhttps://www.docker.com/products/docker-desktop

# æˆ–ä½¿ç”¨Homebrewï¼ˆå¯èƒ½å› macOSç‰ˆæœ¬é—®é¢˜å¤±è´¥ï¼‰
brew install --cask docker
```

### é—®é¢˜3ï¼šæƒé™é—®é¢˜
```bash
# å¦‚æœpsqlå‘½ä»¤æç¤ºæƒé™é—®é¢˜
sudo -u postgres psql

# æˆ–ä¿®æ”¹pg_hba.confé…ç½®
```

### é—®é¢˜4ï¼šæ•°æ®åº“è¿ç§»å¤±è´¥
```bash
# æŸ¥çœ‹è¿ç§»æ–‡ä»¶
ls -la /Users/qihongrui/Desktop/LyricNote/packages/backend/drizzle/migrations/

# æ‰‹åŠ¨è¿è¡ŒSQL
psql -U lyricnote_dev -d lyricnote_dev -f /Users/qihongrui/Desktop/LyricNote/packages/backend/drizzle/migrations/0000_lovely_lilandra.sql
```

---

## ğŸ“ éªŒè¯æ¸…å•

å®ŒæˆåéªŒè¯ï¼š

- [ ] PostgreSQLæ­£åœ¨è¿è¡Œ
  ```bash
  ps aux | grep postgres | grep -v grep
  # æˆ–
  docker ps | grep lyricnote-postgres
  ```

- [ ] å¯ä»¥è¿æ¥æ•°æ®åº“
  ```bash
  psql -U lyricnote_dev -d lyricnote_dev -h localhost -p 5433
  ```

- [ ] æ•°æ®åº“è¡¨å·²åˆ›å»º
  ```bash
  psql -U lyricnote_dev -d lyricnote_dev -h localhost -p 5433 -c "\dt"
  ```

- [ ] Backendåº”ç”¨å¯ä»¥å¯åŠ¨
  ```bash
  cd /Users/qihongrui/Desktop/LyricNote/packages/backend
  pnpm dev
  ```

- [ ] å¯ä»¥è®¿é—®ç®¡ç†åå°
  ```
  http://localhost:3000/admin/login
  ```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### å¼€å‘ç¯å¢ƒæ¨è
1. **ä½¿ç”¨Docker PostgreSQL**
   - éš”ç¦»ç¯å¢ƒ
   - æ˜“äºæ¸…ç†å’Œé‡ç½®
   - ç‰ˆæœ¬æ§åˆ¶æ–¹ä¾¿

2. **ä½¿ç”¨docker-compose**ï¼ˆå¯é€‰ï¼‰
   ```yaml
   # docker-compose.yml
   version: '3.8'
   services:
     postgres:
       image: postgres:15-alpine
       environment:
         POSTGRES_USER: lyricnote_dev
         POSTGRES_PASSWORD: dev_password_123
         POSTGRES_DB: lyricnote_dev
       ports:
         - "5433:5432"
       volumes:
         - pgdata:/var/lib/postgresql/data
   
   volumes:
     pgdata:
   ```
   
   å¯åŠ¨ï¼š
   ```bash
   docker-compose up -d
   ```

### ç”Ÿäº§ç¯å¢ƒ
- ä½¿ç”¨äº‘æ•°æ®åº“ï¼ˆå¦‚Aliyun RDSã€AWS RDSï¼‰
- é…ç½®åœ¨ `.env.production`

---

## ğŸ†˜ è¿˜æ˜¯æ— æ³•è§£å†³ï¼Ÿ

å¦‚æœä»¥ä¸Šæ–¹æ¡ˆéƒ½ä¸è¡Œï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. PostgreSQLç‰ˆæœ¬
   ```bash
   psql --version
   ```

2. ç³»ç»Ÿä¿¡æ¯
   ```bash
   uname -a
   sw_vers
   ```

3. ç«¯å£å ç”¨æƒ…å†µ
   ```bash
   lsof -i :5432
   lsof -i :5433
   ```

4. å®Œæ•´é”™è¯¯æ—¥å¿—
   ```bash
   cd packages/backend
   pnpm dev 2>&1 | tee backend-error.log
   ```

æˆ‘ä¼šæ ¹æ®è¿™äº›ä¿¡æ¯æä¾›æ›´å…·ä½“çš„è§£å†³æ–¹æ¡ˆã€‚

