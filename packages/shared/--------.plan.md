<!-- 095b2833-853f-4b5a-abcc-ef0b1f305526 aaa5b05f-20de-4742-8626-2ef5eb1c8867 -->

# 微信登录和支付集成方案

## 阶段一：准备工作

### 1. 微信账号申请指导文档

创建 `WECHAT_SETUP_GUIDE.md` 文档，包含：

- 微信开放平台账号申请（用于网页和 APP 登录）
- 微信公众平台账号申请（用于小程序）
- 微信商户平台账号申请（用于支付）
- 各平台 AppID、AppSecret、API 密钥获取流程
- 回调域名配置说明

### 2. 数据库设计

在 `packages/backend/drizzle/migrations/schema.ts` 中添加：

**用户微信绑定表 (user_wechat_bindings)**

```typescript
- user_id (关联用户)
- platform (web/miniapp/mobile)
- openid (微信 openid)
- unionid (微信 unionid，用于跨平台识别)
- nickname, avatar (微信用户信息)
- access_token, refresh_token
- created_at, updated_at
```

**支付订单表 (payment_orders)**

```typescript
- order_id (订单号)
- user_id (用户 ID)
- platform (支付平台：wechat)
- trade_type (支付类型：JSAPI/NATIVE/APP/MWEB)
- amount (金额，单位分)
- currency (货币类型)
- product_id, product_name, description
- status (pending/paid/cancelled/refunded)
- transaction_id (微信支付订单号)
- prepay_id (预支付 ID)
- payment_time
- callback_data (回调数据)
- created_at, updated_at
```

**支付日志表 (payment_logs)**

```typescript
(-order_id - action(create / notify / query / refund) - request_data,
  response_data - status(success / failed) - created_at);
```

---

## 阶段二：Shared 包 - 类型和工具

在 `packages/shared/src/` 创建模块：

### 1. 类型定义 `wechat/types.ts`

```typescript
// 登录相关类型
interface WechatLoginParams {
  platform: 'web' | 'miniapp' | 'mobile';
  code?: string; // 授权码
  state?: string; // 网页登录状态参数
}

interface WechatUserInfo {
  openid: string;
  unionid?: string;
  nickname: string;
  avatar: string;
  // ...
}

// 支付相关类型
interface PaymentCreateParams {
  userId: number;
  platform: 'web' | 'miniapp' | 'mobile';
  amount: number; // 单位：分
  productId: string;
  productName: string;
  description: string;
  notifyUrl: string;
}

interface PaymentResult {
  orderId: string;
  prepayId?: string;
  codeUrl?: string; // 网页扫码支付
  paymentParams?: any; // 小程序/APP 支付参数
}
```

### 2. 工具函数 `wechat/utils.ts`

```typescript
// 签名验证
export function verifyWechatSignature(
  data: any,
  signature: string,
  key: string
): boolean;

// 生成随机字符串
export function generateNonceStr(): string;

// 生成订单号
export function generateOrderId(): string;

// 金额转换（元 -> 分）
export function yuan2fen(amount: number): number;
```

---

## 阶段三：Backend - 核心服务

### 1. 配置管理

在 `config-templates-new.ts` 添加微信配置：

```typescript
[ConfigCategory.WECHAT]: [
  { key: 'wechat_web_appid', description: '网页应用AppID' },
  { key: 'wechat_web_appsecret', isSensitive: true },
  { key: 'wechat_miniapp_appid', description: '小程序AppID' },
  { key: 'wechat_miniapp_appsecret', isSensitive: true },
  { key: 'wechat_mobile_appid', description: 'APP应用AppID' },
  { key: 'wechat_mobile_appsecret', isSensitive: true },
  { key: 'wechat_mch_id', description: '商户号' },
  { key: 'wechat_mch_key', description: '商户API密钥', isSensitive: true },
  { key: 'wechat_cert_path', description: '商户证书路径' },
]
```

### 2. 微信登录服务 `lib/wechat/auth-service.ts`

```typescript
class WechatAuthService {
  // 获取网页授权 URL
  getWebAuthUrl(redirectUri: string, state: string): string;

  // 网页登录：code 换取 access_token
  async webLogin(code: string): Promise<WechatUserInfo>;

  // 小程序登录：code 换取 session_key 和 openid
  async miniappLogin(code: string): Promise<WechatUserInfo>;

  // APP 登录：code 换取 access_token
  async mobileLogin(code: string): Promise<WechatUserInfo>;

  // 刷新 access_token
  async refreshToken(refreshToken: string): Promise<any>;

  // 绑定或创建用户
  async bindOrCreateUser(
    platform: string,
    userInfo: WechatUserInfo
  ): Promise<User>;
}
```

### 3. 微信支付服务 `lib/wechat/payment-service.ts`

```typescript
class WechatPaymentService {
  // 创建支付订单
  async createOrder(params: PaymentCreateParams): Promise<PaymentResult>;

  // 网页支付（Native 扫码）
  async createNativePayment(orderId: string): Promise<{ codeUrl: string }>;

  // 小程序支付（JSAPI）
  async createMiniappPayment(orderId: string, openid: string): Promise<any>;

  // APP 支付
  async createMobilePayment(orderId: string): Promise<any>;

  // 支付回调处理
  async handlePaymentNotify(xmlData: string): Promise<boolean>;

  // 查询订单状态
  async queryOrder(orderId: string): Promise<any>;

  // 退款
  async refund(
    orderId: string,
    refundAmount: number,
    reason: string
  ): Promise<any>;

  // 签名生成
  private generateSignature(params: any): string;

  // 验证回调签名
  private verifyNotifySignature(data: any): boolean;
}
```

### 4. API 路由

**登录相关 API**

- `POST /api/auth/wechat/login` - 统一登录接口
- `GET /api/auth/wechat/callback` - 网页登录回调
- `POST /api/auth/wechat/bind` - 绑定微信账号
- `POST /api/auth/wechat/unbind` - 解绑微信账号

**支付相关 API**

- `POST /api/payment/wechat/create` - 创建支付订单
- `POST /api/payment/wechat/notify` - 支付回调（微信服务器调用）
- `GET /api/payment/wechat/query/:orderId` - 查询订单状态
- `POST /api/payment/wechat/refund` - 申请退款
- `GET /api/payment/wechat/orders` - 用户订单列表

---

## 阶段四：各端适配

### 1. Backend Web 端 (`packages/backend`)

**登录组件 `components/wechat-login.tsx`**

```typescript
// 显示微信扫码登录
- 生成授权 URL
- 显示二维码
- 轮询登录状态
- 登录成功后跳转
```

**支付组件 `components/wechat-payment.tsx`**

```typescript
// Native 扫码支付
-创建订单 - 显示支付二维码 - 轮询支付状态 - 支付成功回调;
```

### 2. Miniapp 小程序端 (`packages/miniapp`)

**登录适配 `services/wechat-auth.ts`**

```typescript
// 调用 wx.login() 获取 code
// 调用后端 API 完成登录
// 保存用户信息和 token
```

**支付适配 `services/wechat-payment.ts`**

```typescript
// 调用 wx.requestPayment()
// 处理支付结果
// 支付成功后更新订单状态
```

### 3. Mobile APP 端 (`packages/mobile`)

**登录适配 `services/wechat-auth.ts`**

```typescript
// 集成微信 SDK (react-native-wechat-lib)
// 调用微信登录
// 处理登录回调
```

**支付适配 `services/wechat-payment.ts`**

```typescript
// 调用微信支付 SDK
// 处理支付结果回调
```

---

## 阶段五：测试和文档

### 1. 创建测试用例

- 各端登录流程测试
- 支付流程测试
- 回调处理测试
- 退款流程测试

### 2. 用户文档

创建 `WECHAT_USER_GUIDE.md`：

- 用户如何使用微信登录
- 支付流程说明
- 常见问题解答

### 3. 开发文档

创建 `WECHAT_DEV_GUIDE.md`：

- API 接口文档
- 各端集成示例
- 调试技巧
- 常见错误处理

---

## 关键依赖包

需要安装：

```bash
# Backend
pnpm add wechatpay-node-v3  # 微信支付 SDK V3
pnpm add axios

# Miniapp
# 使用 Taro 内置的微信 API

# Mobile
pnpm add react-native-wechat-lib  # 微信 SDK
```

---

## 注意事项

1. 微信支付回调必须使用 HTTPS
2. 需要配置服务器 IP 白名单
3. 商户证书需要妥善保管
4. Unionid 用于跨平台用户识别
5. 支付金额必须使用"分"为单位
6. 需要处理支付重复通知问题
7. 订单号必须全局唯一

### To-dos

- [x] 创建微信账号申请指导文档 (WECHAT_SETUP_GUIDE.md)
- [x] 设计并创建数据库表（user_wechat_bindings, payment_orders, payment_logs）
- [x] 在 shared 包创建微信相关类型定义和工具函数
- [x] 添加微信相关配置项到配置管理系统
- [x] 实现 WechatAuthService（登录服务）
- [x] 实现 WechatPaymentService（支付服务）
- [x] 创建登录相关 API 路由
- [x] 创建支付相关 API 路由
- [x] 实现 backend web 端登录和支付组件
- [x] 实现小程序端登录和支付适配
- [x] 实现 mobile 端登录和支付适配
- [ ] 编写测试用例和进行集成测试
- [x] 完善用户文档和开发文档
